<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì‹¤ì‹œê°„ ì±„íŒ… í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
</head>
<body>
<h2>ì‹¤ì‹œê°„ ì±„íŒ… í…ŒìŠ¤íŠ¸</h2>

<div>
    <label>ë³´ë‚´ëŠ” ì‚¬ëŒ ID:</label>
    <input type="number" id="senderId" value="1"><br>

    <label>ë°›ëŠ” ì‚¬ëŒ ID:</label>
    <input type="number" id="receiverId" value="2"><br>

    <label>ë©”ì‹œì§€:</label>
    <input type="text" id="message" value="ì•ˆë…•í•˜ì„¸ìš”! ì‹¤ì‹œê°„ ì±„íŒ… í…ŒìŠ¤íŠ¸ ì¤‘ì´ì—ìš”"><br><br>

    <button onclick="connect()">ì„œë²„ ì—°ê²°</button>
    <button onclick="sendMessage()">ë©”ì‹œì§€ ì „ì†¡</button>
</div>

<hr>
<div id="chatBox" style="border:1px solid #ccc; width:400px; height:300px; overflow:auto;"></div>

<script>
    let stompClient = null;
    let senderId = null;
    let receiverId = null;

    function connect() {
        senderId = document.getElementById("senderId").value;
        receiverId = document.getElementById("receiverId").value;

        if (!senderId || !receiverId) {
            alert("ë³´ë‚´ëŠ” ì‚¬ëŒ IDì™€ ë°›ëŠ” ì‚¬ëŒ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        // SockJS ì—°ê²°
        const socket = new SockJS('http://localhost:8080/ws/chat');

        // âš¡ ì—¬ê¸°ì„œ Stomp ê°ì²´ ì‚¬ìš©
        stompClient = StompJs.Stomp.over(socket);

        stompClient.connect({}, function () {
            console.log('âœ… WebSocket ì—°ê²°ë¨');

            // ìˆ˜ì‹ ì í êµ¬ë…
            stompClient.subscribe(`/queue/${receiverId}`, function (msg) {
                const chat = JSON.parse(msg.body);
                console.log('ğŸ“© ë°›ì€ ë©”ì‹œì§€:', chat.message);
                showMessage(chat);
            });
        }, function (error) {
            console.error('âŒ WebSocket ì—°ê²° ì‹¤íŒ¨:', error);
        });
    }

    function sendMessage() {
        if (!stompClient) {
            alert("ì„œë²„ì— ì—°ê²° í›„ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ì„¸ìš”.");
            return;
        }

        const msg = document.getElementById("message").value;

        stompClient.send('/app/chat.sendMessage', {}, JSON.stringify({
            senderId: senderId,
            receiverId: receiverId,
            message: msg,
            type: 'TEXT'
        }));

        document.getElementById("message").value = '';
    }

    function showMessage(chat) {
        const chatBox = document.getElementById("chatBox");
        const div = document.createElement("div");
        div.textContent = `[${chat.senderId} â¤ ${chat.receiverId}] ${chat.message}`;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }
</script>
</body>
</html>
